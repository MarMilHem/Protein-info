<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Protein Info</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f7f9fc;
      color: #222;
      margin: 0;
      padding: 2rem;
      text-align: center;
    }
    h1 { color: #0059ff; margin-bottom: 1rem; }
    h2 { margin: 1.5rem 0 .75rem; }
    .btn {
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      transition: background .2s;
    }
    .btn:hover { background: #ddd; }
    .btn-primary {
      background: #0059ff;
      color: white;
      border-color: #0059ff;
    }
    .btn-primary:hover { background: #0045d0; }

    table.compare {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: .95rem;
    }
    table.compare th,
    table.compare td {
      padding: .5rem;
      border-bottom: 1px solid #ddd;
    }
    table.compare th.num,
    table.compare td.num {
      text-align: right;
    }

    .chip {
      display:inline-block;
      background:#e5eaff;
      color:#0059ff;
      border-radius:999px;
      padding:0 8px;
      font-size:.8rem;
      margin-left:4px;
    }

    footer {
      margin-top: 3rem;
      font-size: 0.9rem;
      color: #777;
    }

    /* search bar + filters */
    .search-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
    }
    .search-bar input,
    .search-bar select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .search-bar input { flex: 1; min-width: 220px; }
    .result {
      background:white;
      padding:12px;
      border-radius:8px;
      margin-bottom:10px;
      text-align:left;
      box-shadow:0 1px 3px rgba(0,0,0,0.06);
    }
  </style>
</head>
<body>
  <main>
    <h1>Protein Info</h1>
    <p>Explore and compare different protein brands ‚Äî their macros, price, and quality.</p>

    <!-- üîç Unified Search + Filters -->
    <form id="brandSearchForm" class="search-bar">
      <input type="text" name="q" placeholder="Search for a protein brand..." required />
      <select name="type" id="filterType">
        <option value="">All types</option>
        <option value="whey">Whey</option>
        <option value="isolate">Isolate</option>
        <option value="vegan">Vegan</option>
      </select>
      <select name="sort" id="sortOrder">
        <option value="">Sort by</option>
        <option value="price">Lowest price</option>
        <option value="protein">Highest protein</option>
        <option value="calories">Lowest calories</option>
      </select>
      <button type="submit" class="btn btn-primary">üîç Search</button>
    </form>

    <div id="brandResults"></div>

    <!-- üî¢ Comparison Table (serving-based) -->
    <section id="compare-section" style="margin:24px 0;">
      <div id="compare-wrap">
        <div id="compare-head">
          <h2>Compare products <span class="chip" id="compare-count">0</span></h2>
          <div class="toolbar">
            <button class="btn" id="clearBtn" type="button">Clear</button>
            <button class="btn" id="shareBtn" type="button">Share link</button>
            <button class="btn btn-primary" id="loadExamplesBtn" type="button">Load demo</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="compare" id="compareTable" aria-label="Protein comparison table">
            <thead>
              <tr>
                <th data-key="brand">Brand</th>
                <th data-key="product">Product</th>
                <th class="num" data-key="servingSizeG">Serving (g)</th>
                <th class="num" data-key="pricePerServing">Price / serving</th>
                <th class="num" data-key="proteinPerServing">Protein / serving</th>
                <th class="num" data-key="caloriesPerServing">Calories / serving</th>
                <th class="num" data-key="carbsPerServing">Carbs / serving</th>
                <th class="num" data-key="fatPerServing">Fat / serving</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="compareBody"></tbody>
          </table>
        </div>

        <div id="compare-empty">No items yet. Use your search results or the list above to ‚ÄúAdd to compare‚Äù.</div>
      </div>
    </section>

    <footer>&copy; 2025 Protein Info. All rights reserved.</footer>
  </main>

  <!-- ‚úÖ Helper: safely create IDs and forward to Compare.add -->
  <script>
    window.addToCompare = function(raw){
      const item = { ...raw };
      if (!item.id) {
        const slug = s => String(s||"").toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)+/g,'');
        item.id = [slug(item.brand), slug(item.product)].filter(Boolean).join('-') || 'item-' + Date.now();
      }
      const num = v => (v===null||v===undefined||v==='') ? undefined : Number(v);
      item.pricePerKg = num(item.pricePerKg);
      item.servingSizeG = num(item.servingSizeG);
      item.proteinPer100g = num(item.proteinPer100g);
      item.caloriesPerServing = num(item.caloriesPerServing);
      item.carbsPerServing = num(item.carbsPerServing);
      item.fatPerServing = num(item.fatPerServing);
      const tryAdd = () => (window.Compare?.add ? window.Compare.add(item) : setTimeout(tryAdd, 50));
      tryAdd();
    };
  </script>

  <!-- üîé Search + filter logic -->
  <script>
    const formEl = document.getElementById('brandSearchForm');
    const resultsEl = document.getElementById('brandResults');

    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const query = formEl.q.value.trim();
      const type = formEl.type.value;
      const sort = formEl.sort.value;

      resultsEl.textContent = "üîç Searching...";

      try {
        const params = new URLSearchParams({ q: query, type, sort });
        const res = await fetch(`/search?${params.toString()}`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Search failed");

        let items = data.results || [];
        if (!items.length) {
          resultsEl.textContent = "No matching protein brands.";
          return;
        }

        // client-side sort
        if (sort === "price") items.sort((a,b)=>(a.pricePerKg??9999)-(b.pricePerKg??9999));
        if (sort === "protein") items.sort((a,b)=>(b.proteinPer100g??0)-(a.proteinPer100g??0));
        if (sort === "calories") items.sort((a,b)=>(a.caloriesPer100g??9999)-(b.caloriesPer100g??9999));

        // client-side type filter
        if (type) items = items.filter(p => (p.type||"").toLowerCase().includes(type.toLowerCase()));

        resultsEl.innerHTML = items.map(p => `
          <article class="result">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
              <div>
                <div style="font-weight:700;">${p.brand}</div>
                <div>${p.product}</div>
                <div style="font-size:.9rem;color:#666;">${p.type || ""}</div>
              </div>
              <button class="btn" onclick='addToCompare(${JSON.stringify(p)})'>+ Add to compare</button>
            </div>
            <div style="margin-top:.5rem;font-size:.9rem;color:#444;">
              <strong>Serving:</strong> ${p.servingSizeG ?? "‚Äî"} g ¬∑
              <strong>Protein/100g:</strong> ${p.proteinPer100g ?? "‚Äî"} g ¬∑
              <strong>Price/kg:</strong> ${p.pricePerKg!=null?"‚Ç¨"+Number(p.pricePerKg).toFixed(2):"‚Äî"}
            </div>
          </article>
        `).join('');
      } catch (err) {
        resultsEl.innerHTML = `<span style="color:red;">‚ùå ${err.message}</span>`;
      }
    });
  </script>

  <!-- ‚öôÔ∏è Compare module -->
  <script>
  (() => {
    const STORAGE_KEY = 'protein_compare_items_v1';
    const els = {
      count: document.getElementById('compare-count'),
      table: document.getElementById('compareTable'),
      body:  document.getElementById('compareBody'),
      empty: document.getElementById('compare-empty'),
      clear: document.getElementById('clearBtn'),
      share: document.getElementById('shareBtn'),
      demo:  document.getElementById('loadExamplesBtn'),
    };

    const load = () => {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
      catch { return []; }
    };
    const save = (items) => localStorage.setItem(STORAGE_KEY, JSON.stringify(items));

    const num = v => (v===null||v===undefined||v==='') ? undefined : Number(v);
    const fmt = (v,d=1)=>(v==null||Number.isNaN(v))?'‚Äî':Number(v).toFixed(d);
    const money = v=>(v==null||Number.isNaN(v))?'‚Äî':new Intl.NumberFormat(undefined,{style:'currency',currency:'EUR'}).format(Number(v));

    function deriveServingFields(item){
      const x={...item};
      x.servingSizeG=num(x.servingSizeG);
      x.pricePerServing=num(x.pricePerServing);
      x.pricePerKg=num(x.pricePerKg);
      x.proteinPerServing=num(x.proteinPerServing);
      x.proteinPer100g=num(x.proteinPer100g);
      x.caloriesPerServing=num(x.caloriesPerServing);
      x.caloriesPer100g=num(x.caloriesPer100g);
      x.carbsPerServing=num(x.carbsPerServing);
      x.carbsPer100g=num(x.carbsPer100g);
      x.fatPerServing=num(x.fatPerServing);
      x.fatPer100g=num(x.fatPer100g);
      if(x.servingSizeG){
        if(x.pricePerServing==null&&x.pricePerKg!=null)x.pricePerServing=(x.pricePerKg*x.servingSizeG)/1000;
        if(x.proteinPerServing==null&&x.proteinPer100g!=null)x.proteinPerServing=(x.proteinPer100g*x.servingSizeG)/100;
        if(x.caloriesPerServing==null&&x.caloriesPer100g!=null)x.caloriesPerServing=(x.caloriesPer100g*x.servingSizeG)/100;
        if(x.carbsPerServing==null&&x.carbsPer100g!=null)x.carbsPerServing=(x.carbsPer100g*x.servingSizeG)/100;
        if(x.fatPerServing==null&&x.fatPer100g!=null)x.fatPerServing=(x.fatPer100g*x.servingSizeG)/100;
      }
      return x;
    }

    function render(){
      const items=load();
      els.count.textContent=String(items.length);
      const has=items.length>0;
      els.table.style.display=has?'table':'none';
      els.empty.style.display=has?'none':'block';
      if(!has){els.body.innerHTML='';return;}
      els.body.innerHTML=items.map(i=>{
        const it=deriveServingFields(i);
        return `
          <tr data-id="${it.id}">
            <td>${it.brand??'‚Äî'}</td>
            <td>${it.product??'‚Äî'}</td>
            <td class="num">${fmt(it.servingSizeG,0)}</td>
            <td class="num">${money(it.pricePerServing)}</td>
            <td class="num">${fmt(it.proteinPerServing,1)}</td>
            <td class="num">${fmt(it.caloriesPerServing,0)}</td>
            <td class="num">${fmt(it.carbsPerServing,1)}</td>
            <td class="num">${fmt(it.fatPerServing,1)}</td>
            <td><button class="btn remove" data-id="${it.id}">Remove</button></td>
          </tr>
        `;
      }).join('');
    }

    window.Compare={
      add(raw){
        const item=deriveServingFields(raw);
        const items=load();
        const idx=items.findIndex(x=>x.id===item.id);
        if(idx>=0)items[idx]={...items[idx],...item}; else items.push(item);
        save(items); render();
      },
      remove(id){ save(load().filter(x=>x.id!==id)); render(); },
      clear(){ save([]); render(); },
      getAll(){ return load(); },
    };

    document.addEventListener('click',e=>{
      const btn=e.target.closest('.remove');
      if(btn&&btn.dataset.id){e.preventDefault();window.Compare.remove(btn.dataset.id);}
    });

    els.clear?.addEventListener('click',()=>window.Compare.clear());
    els.share?.addEventListener('click',async()=>{
      const data=window.Compare.getAll();
      const payload=btoa(unescape(encodeURIComponent(JSON.stringify(data))));
      const url=new URL(location.href); url.hash='cmp='+payload;
      try{
        await navigator.clipboard.writeText(url.toString());
        els.share.textContent='Copied!';
        setTimeout(()=>els.share.textContent='Share link',1200);
      }catch{ prompt('Copy this link:',url.toString()); }
    });

    els.demo?.addEventListener('click',()=>{
      const demo=[
        {id:'esn-designer-vanilla',brand:'ESN',product:'Designer Whey (Vanilla)',servingSizeG:30,proteinPer100g:77,pricePerKg:24.99},
        {id:'optimum-gold-standard',brand:'Optimum Nutrition',product:'Gold Standard Whey',servingSizeG:30,proteinPer100g:76,pricePerKg:28.90},
        {id:'myprotein-impact',brand:'MyProtein',product:'Impact Whey',servingSizeG:25,proteinPer100g:79,pricePerKg:19.99},
      ];
      const items=load().concat(demo.filter(d=>!load().some(i=>i.id===d.id)));
      save(items); render();
    });

    (function importFromHash(){
      const m=location.hash.match(/(^|#|&)cmp=([^&]+)/);
      if(!m)return render();
      try{
        const json=decodeURIComponent(escape(atob(m[2])));
        const items=JSON.parse(json);
        if(Array.isArray(items))save(items);
      }catch{}
      render();
    })();
  })();
  </script>
</body>
</html>
