<!DOCTYPE html>
<html lang="en">
<meta name="robots" content="noindex, nofollow">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Protein Info ‚Äî EU</title>
  <style>
    :root{
      --bg:#f7f9fc; --text:#1f2937; --muted:#6b7280; --ring:#e5e7eb;
      --brand:#0059ff; --brand-600:#0045d0;
      --card:#ffffff; --shadow:0 6px 24px rgba(0,0,0,.07);
      --best:#10b98120; --best-ring:#10b98155;
    }

    body {
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 2rem;
      text-align: center;
      line-height: 1.55;
    }
    h1 { color: var(--brand); margin-bottom: .5rem; }
    h2 { margin: 1.5rem 0 .75rem; }

    /* ====== GEOMETRIC GRID BACKGROUND (animated) ====== */
    body::before{
      content:""; position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        linear-gradient(to right, rgba(0,0,0,.04) 1px, transparent 1px) 0 0 / 28px 28px,
        linear-gradient(to bottom, rgba(0,0,0,.04) 1px, transparent 1px) 0 0 / 28px 28px;
      mask: radial-gradient(1200px 800px at 50% 10%, #000 55%, transparent 100%);
      animation: gridDrift 60s linear infinite;
    }
    @keyframes gridDrift {
      from { background-position: 0 0, 0 0; }
      to   { background-position: 200px 200px, 200px 200px; }
    }

    /* icons / badges */
    .badges{display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap;margin:.25rem 0 1rem}
    .badge{display:inline-flex;align-items:center;gap:.5rem;background:var(--card);border:1px solid var(--ring);
      padding:.4rem .6rem;border-radius:999px;box-shadow:var(--shadow);font-weight:600}
    .badge svg{width:18px;height:18px;fill:currentColor;color:var(--brand)}

    .btn {
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      transition: background .2s;
    }
    .btn:hover { background: #ddd; }
    .btn-primary {
      background: var(--brand);
      color: white;
      border-color: var(--brand);
    }
    .btn-primary:hover { background: var(--brand-600); }

    /* search bar + filters */
    .search-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
    }
    .search-bar input,
    .search-bar select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background: #fff;
      box-shadow: var(--shadow);
    }
    .search-bar input { flex: 0 1 480px; min-width: 220px; max-width: 520px; }

    /* üîΩ Autocomplete (type-ahead) */
    .combo { position: relative; flex: 0 1 480px; min-width: 220px; max-width: 520px; }
    .combo[aria-expanded="true"] input {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }
    .suggestions {
      position: absolute; z-index: 20; top: 100%; left: 0; right: 0;
      background: #fff; border: 1px solid var(--ring); border-top: none;
      border-bottom-left-radius: 10px; border-bottom-right-radius: 10px;
      box-shadow: 0 8px 24px rgba(0,0,0,.08);
      max-height: 320px; overflow: auto; margin: 0; padding: 0; list-style: none; display: none;
    }
    .combo[aria-expanded="true"] .suggestions { display: block; }
    .suggestions li[role="option"] {
      padding: 10px 12px; cursor: pointer; display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center;
    }
    .suggestions li small { color: var(--muted); }
    .suggestions li .tag { font-size: 12px; padding: 2px 8px; border-radius: 999px; background: #f3f4f6; }
    .suggestions li[aria-selected="true"], .suggestions li:hover { background: #f7f9fc; }

    /* Results grid (cards) */
    #brandResults { margin: 0 auto 1rem; }
    .card-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      align-items: stretch;
      text-align:left;
    }
    .card{
      background:var(--card);
      border:1px solid var(--ring);
      border-radius:14px;
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      transition:transform .12s ease;
    }
    .card:hover{ transform: translateY(-2px); }
    .card .img{ aspect-ratio: 1/1; background:#eef2ff; display:grid; place-items:center; overflow:hidden }
    .card .img img{ width:100%; height:100%; object-fit:cover }
    .card .body{ padding:.8rem .9rem; display:flex; flex-direction:column; gap:.35rem }
    .card .brand{ font-weight:700 }
    .card .name{ font-size:.95rem; min-height:2.4em; line-height:1.3 }
    .card .meta{ font-size:.85rem; color:var(--muted) }
    .tags{ display:flex; flex-wrap:wrap; gap:.35rem; margin-top:.35rem }
    .tag{ font-size:.72rem; border:1px solid var(--ring); padding:.12rem .45rem; border-radius:999px; background:#fff }
    .actions{ display:flex; gap:.5rem; margin-top:.6rem }

    /* Compare table styling */
    .table-wrap{
      overflow:auto;
      background:linear-gradient(#fff,#fff) padding-box, linear-gradient(to right, transparent, transparent) border-box;
      border:1px solid var(--ring);
      border-radius:14px;
      box-shadow:var(--shadow);
    }
    table.compare {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: .95rem;
      min-width: 760px;
      text-align:left;
    }
    table.compare th,
    table.compare td {
      padding: .7rem .9rem;
      border-bottom: 1px solid var(--ring);
    }
    table.compare th.num,
    table.compare td.num { text-align: right; }
    .compare thead th{
      position:sticky; top:0; background:#fff; z-index:1;
      font-size:.9rem; color:#111;
    }
    .compare tbody tr:nth-child(odd){background:#fafafa}
    .compare tbody tr:hover{background:#f3f7ff}

    /* protein visualization */
    .metric .bar{height:8px;border-radius:6px;background:#e5e7eb;position:relative;overflow:hidden;margin-top:4px}
    .metric .bar > i{position:absolute;inset:0;width:0%;display:block;background:linear-gradient(90deg,#93c5fd,#60a5fa)}
    td.protein.is-best{background:var(--best)!important;box-shadow:inset 0 0 0 2px var(--best-ring)}
    .best-tag{display:inline-flex;align-items:center;gap:.35rem;background:#10b981;color:#053c2a;border-radius:999px;padding:.15rem .45rem;font-size:.75rem;font-weight:700;margin-left:.5rem}

    .chip {
      display:inline-block;
      background:#e5eaff;
      color:var(--brand);
      border-radius:999px;
      padding:0 8px;
      font-size:.8rem;
      margin-left:4px;
    }

    footer {
      margin-top: 3rem;
      font-size: 0.9rem;
      color: #777;
    }

    .compare thead th:first-child{border-top-left-radius:14px}
    .compare thead th:last-child{border-top-right-radius:14px}
    .compare tbody tr:last-child td:first-child{border-bottom-left-radius:14px}
    .compare tbody tr:last-child td:last-child{border-bottom-right-radius:14px}

    #compare-head{display:flex;align-items:center;justify-content:space-between;gap:.75rem;flex-wrap:wrap}
    #compare-empty{color:var(--muted);margin:.75rem 0}
  </style>
</head>
<body>
  <main>
    <h1>Protein Info ‚Äî EU Brands</h1>

    <div class="badges">
      <span class="badge" title="Protein">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M4 12a6 6 0 1 1 12 0v2.2l3.6 1.2a2 2 0 1 1-.64 3.9L16 18.5V12A8 8 0 1 0 0 12a1 1 0 0 0 2 0 6 6 0 0 1 2-4z"/>
        </svg>
        Protein
      </span>
      <span class="badge" title="Dietary">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M20.5 3.5c-6.4-.7-10.9 1.6-13.8 4.5C3.2 11.5 2 15.1 2 18.3c0 .9.8 1.7 1.7 1.7 3.2 0 6.8-1.2 10.3-4.7 2.9-2.9 5.2-7.4 4.5-13.8zM9.5 14l-2-2 1.4-1.4 1 1 4-4L15.3 9l-4.9 5z"/>
        </svg>
        Dietary
      </span>
    </div>

    <p>Explore and compare different protein brands available in Europe ‚Äî macros, price, and more.</p>

    <!-- üîç Unified Search + Filters (with autocomplete) -->
    <form id="brandSearchForm" class="search-bar" role="search" aria-label="Search protein brands">
      <div class="combo" aria-expanded="false">
        <input
          id="query"
          type="text"
          name="q"
          placeholder="Search for a protein brand..."
          autocomplete="off"
          required
          role="combobox"
          aria-autocomplete="list"
          aria-owns="suggestions"
          aria-controls="suggestions"
          aria-activedescendant=""
        />
        <ul id="suggestions" class="suggestions" role="listbox"></ul>
      </div>

      <select name="type" id="filterType" aria-label="Filter by type">
        <option value="">All types</option>
        <option value="whey">Whey</option>
        <option value="isolate">Isolate</option>
        <option value="vegan">Vegan</option>
      </select>
      <select name="sort" id="sortOrder" aria-label="Sort order">
        <option value="">Sort by</option>
        <option value="price">Lowest price/kg</option>
        <option value="protein">Highest protein/100g</option>
        <option value="calories">Lowest calories/100g</option>
      </select>
      <button type="submit" class="btn btn-primary">üîç Search</button>
    </form>

    <div id="brandResults"></div>

    <!-- üî¢ Comparison Table (serving-based) -->
    <section id="compare-section" style="margin:24px 0;">
      <div id="compare-wrap">
        <div id="compare-head">
          <h2>Compare products <span class="chip" id="compare-count">0</span></h2>
          <div class="toolbar">
            <button class="btn" id="clearBtn" type="button">Clear</button>
            <button class="btn" id="shareBtn" type="button">Share link</button>
            <button class="btn btn-primary" id="loadExamplesBtn" type="button">Load demo</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="compare" id="compareTable" aria-label="Protein comparison table">
            <thead>
              <tr>
                <th data-key="brand">Brand</th>
                <th data-key="product">Product</th>
                <th class="num" data-key="servingSizeG">Serving (g)</th>
                <th class="num" data-key="pricePerServing">Price / serving</th>
                <th class="num" data-key="proteinPerServing">Protein / serving</th>
                <th class="num" data-key="caloriesPerServing">Calories / serving</th>
                <th class="num" data-key="carbsPerServing">Carbs / serving</th>
                <th class="num" data-key="fatPerServing">Fat / serving</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="compareBody"></tbody>
          </table>
        </div>

        <p class="legend" style="color:var(--muted);margin:.6rem .2rem;text-align:left">
          <span style="display:inline-block;width:12px;height:12px;border-radius:3px;background:var(--best);box-shadow:inset 0 0 0 2px var(--best-ring);vertical-align:middle;margin-right:.35rem"></span>
          Highest protein per serving
        </p>

        <div id="compare-empty">No items yet. Use search results to ‚ÄúAdd to compare‚Äù.</div>
      </div>
    </section>

    <footer>&copy; 2025 Protein Info. All rights reserved.</footer>
  </main>

  <!-- ‚úÖ Helper: safely create IDs and forward to Compare.add -->
  <script>
    window.addToCompare = function(raw){
      const item = { ...raw };
      if (!item.id) {
        const slug = s => String(s||"").toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)+/g,'');
        item.id = [slug(item.brand), slug(item.product)].filter(Boolean).join('-') || 'item-' + Date.now();
      }
      const num = v => (v===null||v===undefined||v==='') ? undefined : Number(v);
      item.pricePerKg = num(item.pricePerKg);
      item.servingSizeG = num(item.servingSizeG);
      item.proteinPer100g = num(item.proteinPer100g);
      item.caloriesPerServing = num(item.caloriesPerServing);
      item.carbsPerServing = num(item.carbsPerServing);
      item.fatPerServing = num(item.fatPerServing);
      const tryAdd = () => (window.Compare?.add ? window.Compare.add(item) : setTimeout(tryAdd, 50));
      tryAdd();
    };
  </script>

  <!-- üîé Local dataset search + autocomplete (reads /api/products) -->
  <script>
    const formEl = document.getElementById('brandSearchForm');
    const resultsEl = document.getElementById('brandResults');

    // Local dataset cache
    const DATA = { products: [], ready: false };

    // Load once on page start
    (async function bootstrap(){
      try{
        resultsEl.innerHTML = '<div style="color:#666">Loading products‚Ä¶</div>';
        const res = await fetch('/api/products', { headers: { 'Cache-Control': 'no-cache' }});
        const raw = await res.json();
        DATA.products = raw.map(normalizeFromBackend).filter(Boolean);
        DATA.ready = true;
        resultsEl.innerHTML = '';
      }catch(e){
        resultsEl.innerHTML = '<div style="color:red">Could not load products.</div>';
      }
    })();

    function normalizeFromBackend(p){
      // Map snake_case (backend) ‚Üí camelCase (frontend)
      const brand = p.brand || '‚Äî';
      const product = p.product || p.name || '‚Äî';
      const origin = p.country_of_origin || p.country || '';
      const servingSizeG = num(p.serving_size_g);
      const proteinPer100g = num(p.protein_per_100g);
      const caloriesPer100g = num(p.kcal_per_100g);
      const carbsPer100g = num(p.carb_per_100g);
      const fatPer100g = num(p.fat_per_100g);
      const priceEur = num(p.price_eur);
      // try to infer price/kg if a "1 kg" format is present
      const has1kg = Array.isArray(p.formats) && p.formats.some(x => /(^|\s)1\s*kg\b/i.test(x));
      const pricePerKg = (priceEur!=null && has1kg) ? priceEur : undefined;
      const type = inferType(product);
      return {
        id: String(p.id || `${brand}-${product}`).toLowerCase().replace(/[^a-z0-9]+/g,'-'),
        brand, product, origin,
        type,
        servingSizeG,
        proteinPer100g,
        caloriesPer100g,
        carbsPer100g,
        fatPer100g,
        pricePerKg,
        image: p.image || '',
        url: p.url || ''
      };
    }
    function num(v){ return (v==null || v==='') ? undefined : Number(v); }
    function inferType(name){
      const s = String(name||'').toLowerCase();
      if(/isolate/.test(s)) return 'isolate';
      if(/vegan|pea|soya|rice|plant/.test(s)) return 'vegan';
      if(/whey|casein|milk/.test(s)) return 'whey';
      return '';
    }
    function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    /* ---------- Autocomplete (pure client-side) ---------- */
    (function initAutocomplete(){
      const combo = formEl.querySelector('.combo');
      const input = document.getElementById('query');
      const list  = document.getElementById('suggestions');

      let debounceTimer=null, activeIndex=-1, items=[];

      function setExpanded(open){
        combo.setAttribute("aria-expanded", open ? "true" : "false");
        if (!open) {
          input.setAttribute("aria-activedescendant", "");
          activeIndex = -1;
        }
      }
      function renderList(data){
        items = data.slice(0, 10);
        activeIndex = -1;
        if (!items.length){ list.innerHTML=""; setExpanded(false); return; }
        list.innerHTML = items.map((p,i)=>{
          const id="opt-"+i;
          const protein = (p.proteinPer100g != null) ? ` ¬∑ ${p.proteinPer100g}g/100g` : "";
          const tag = p.type ? `<span class="tag">${p.type}</span>` : "";
          const origin = p.origin ? ` ¬∑ ${p.origin}` : "";
          return `
            <li id="${id}" role="option" aria-selected="false" data-index="${i}">
              <div><strong>${escapeHTML(p.brand)}</strong> ‚Äî ${escapeHTML(p.product)}<small>${origin}${protein}</small></div>
              ${tag}
            </li>`;
        }).join("");
        setExpanded(true);
      }
      function highlight(index){
        const options=[...list.querySelectorAll('[role="option"]')];
        options.forEach((el,i)=>{
          const sel=i===index;
          el.setAttribute("aria-selected", sel ? "true" : "false");
          if(sel){ input.setAttribute("aria-activedescendant", el.id); el.scrollIntoView({block:"nearest"}); }
        });
      }
      function localSuggest(q){
        if(!DATA.ready) return [];
        const s = q.trim().toLowerCase();
        if(!s) return [];
        return DATA.products.filter(p =>
          (p.brand||'').toLowerCase().includes(s) ||
          (p.product||'').toLowerCase().includes(s)
        ).slice(0, 25);
      }
      function onInput(){
        const q = input.value.trim();
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(()=>{
          if(q.length<1){ renderList([]); return; }
          renderList(localSuggest(q));
        }, 120);
      }
      function choose(index){
        if (index<0 || index>=items.length) return;
        const it = items[index];
        const q = [it.brand, it.product].filter(Boolean).join(" ");
        input.value = q || input.value;
        renderList([]);
        formEl.requestSubmit();
      }

      input.addEventListener("input", onInput);
      input.addEventListener("keydown", (e)=>{
        const open = combo.getAttribute("aria-expanded")==="true";
        if(e.key==="ArrowDown"){
          e.preventDefault();
          if(!open && items.length) setExpanded(true);
          activeIndex = Math.min(items.length-1, activeIndex+1);
          highlight(activeIndex);
        }else if(e.key==="ArrowUp"){
          e.preventDefault();
          activeIndex = Math.max(0, activeIndex-1);
          highlight(activeIndex);
        }else if(e.key==="Enter"){
          if(open && activeIndex>=0){ e.preventDefault(); choose(activeIndex); }
        }else if(e.key==="Escape"){
          setExpanded(false);
        }
      });
      list.addEventListener("mousedown", (e)=>{
        const li = e.target.closest('[role="option"]');
        if(!li) return;
        e.preventDefault();
        choose(Number(li.dataset.index));
      });
      document.addEventListener("click", (e)=>{
        if(!combo.contains(e.target)) setExpanded(false);
      });
    })();
    /* ---------- /Autocomplete ---------- */

    /* ---------- Search submit (client-side filter over DATA.products) ---------- */
    formEl.addEventListener('submit', (e) => {
      e.preventDefault();
      if(!DATA.ready){ resultsEl.textContent = "Still loading products‚Ä¶"; return; }

      const query = formEl.q.value.trim().toLowerCase();
      const type = formEl.type.value;
      const sort = formEl.sort.value;

      let items = DATA.products.filter(p => {
        const hit = !query || (p.brand||'').toLowerCase().includes(query) || (p.product||'').toLowerCase().includes(query);
        const typeOk = !type || (p.type||'').toLowerCase().includes(type);
        return hit && typeOk;
      });

      if (!items.length) {
        resultsEl.innerHTML = "<div style='color:#666'>No matching protein brands.</div>";
        return;
      }

      if (sort === "price") items.sort((a,b)=>(a.pricePerKg??9999)-(b.pricePerKg??9999));
      if (sort === "protein") items.sort((a,b)=>(b.proteinPer100g??0)-(a.proteinPer100g??0));
      if (sort === "calories") items.sort((a,b)=>(a.caloriesPer100g??9999)-(b.caloriesPer100g??9999));

      renderResults(items);
    });

    function renderResults(items){
      resultsEl.className = 'card-grid';
      resultsEl.innerHTML = items.map(cardHTML).join('');
    }

    function cardHTML(p){
      const img = p.image ? `<img loading="lazy" src="${p.image}" alt="${escapeHTML(p.product)}">` : "ü•§";
      const price = (p.pricePerKg!=null) ? `‚Ä¢ ‚Ç¨${Number(p.pricePerKg).toFixed(2)}/kg` : "";
      const kcal = (p.caloriesPer100g!=null) ? `${p.caloriesPer100g} kcal/100g` : "‚Äî";
      const prot = (p.proteinPer100g!=null) ? `${p.proteinPer100g}g/100g` : "‚Äî";
      const tags = [
        p.type ? `<span class="tag">${escapeHTML(p.type)}</span>` : "",
        p.origin ? `<span class="tag">${escapeHTML(p.origin)}</span>` : ""
      ].join('');
      const addPayload = escapeHTML(JSON.stringify(p));
      return `
        <article class="card">
          <div class="img">${img}</div>
          <div class="body">
            <div class="brand">${escapeHTML(p.brand)}</div>
            <div class="name">${escapeHTML(p.product)}</div>
            <div class="meta">${prot} ‚Ä¢ ${kcal} ${price ? ' '+price : ''}</div>
            <div class="tags">${tags}</div>
            <div class="actions">
              <button class="btn btn-primary" onclick='addToCompare(JSON.parse("${addPayload}"))'>Add to compare</button>
              ${p.url ? `<a class="btn" href="${p.url}" target="_blank" rel="noopener">View</a>` : ''}
            </div>
          </div>
        </article>
      `;
    }
  </script>

  <!-- ‚öôÔ∏è Compare module + visualization/highlight -->
  <script>
  (() => {
    const STORAGE_KEY = 'protein_compare_items_v1';
    const els = {
      count: document.getElementById('compare-count'),
      table: document.getElementById('compareTable'),
      body:  document.getElementById('compareBody'),
      empty: document.getElementById('compare-empty'),
      clear: document.getElementById('clearBtn'),
      share: document.getElementById('shareBtn'),
      demo:  document.getElementById('loadExamplesBtn'),
    };

    const load = () => {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
      catch { return []; }
    };
    const save = (items) => localStorage.setItem(STORAGE_KEY, JSON.stringify(items));

    const num = v => (v===null||v===undefined||v==='') ? undefined : Number(v);
    const fmt = (v,d=1)=>(v==null||Number.isNaN(v))?'‚Äî':Number(v).toFixed(d);
  const money = v=>(v==null||Number.isNaN(v))?'‚Äî':new Intl.NumberFormat(undefined,{style:'currency',currency:'EUR'}).format(Number(v));

    function deriveServingFields(item){
      const x={...item};
      x.servingSizeG=num(x.servingSizeG);
      x.pricePerServing=num(x.pricePerServing);
      x.pricePerKg=num(x.pricePerKg);
      x.proteinPerServing=num(x.proteinPerServing);
      x.proteinPer100g=num(x.proteinPer100g);
      x.caloriesPerServing=num(x.caloriesPerServing);
      x.caloriesPer100g=num(x.caloriesPer100g);
      x.carbsPerServing=num(x.carbsPerServing);
      x.carbsPer100g=num(x.carbsPer100g);
      x.fatPerServing=num(x.fatPerServing);
      x.fatPer100g=num(x.fatPer100g);
      if(x.servingSizeG){
        if(x.pricePerServing==null&&x.pricePerKg!=null)x.pricePerServing=(x.pricePerKg*x.servingSizeG)/1000;
        if(x.proteinPerServing==null&&x.proteinPer100g!=null)x.proteinPerServing=(x.proteinPer100g*x.servingSizeG)/100;
        if(x.caloriesPerServing==null&&x.caloriesPer100g!=null)x.caloriesPerServing=(x.caloriesPer100g*x.servingSizeG)/100;
        if(x.carbsPerServing==null&&x.carbsPer100g!=null)x.carbsPerServing=(x.carbsPer100g*x.servingSizeG)/100;
        if(x.fatPerServing==null&&x.fatPer100g!=null)x.fatPerServing=(x.fatPer100g*x.servingSizeG)/100;
      }
      return x;
    }

    function visualizeProteinCells(){
      const table = els.table;
      const proteinCells = Array.from(table.querySelectorAll('tbody tr td:nth-child(5)')); // Protein/serving col
      const values = proteinCells.map(td => {
        const v = Number(String(td.dataset.protein || td.textContent).replace(/[^\d.]/g,''));
        return Number.isFinite(v) ? v : 0;
      });
      const max = Math.max(0, ...values);

      proteinCells.forEach((td, i) => {
        const v = values[i];
        td.classList.add('metric','protein');
        const valText = td.textContent.trim();
        td.innerHTML = '';
        const strong = document.createElement('div');
        strong.style.fontWeight = '600';
        strong.textContent = valText;
        const bar = document.createElement('div'); bar.className='bar';
        const fill = document.createElement('i'); fill.style.width = (max? (v/max)*100 : 0) + '%';
        bar.appendChild(fill);
        td.appendChild(strong);
        td.appendChild(bar);
      });

      const bestIndex = values.indexOf(max);
      if(bestIndex>=0 && proteinCells[bestIndex]){
        const best = proteinCells[bestIndex];
        best.classList.add('is-best');
        const tag = document.createElement('span');
        tag.className='best-tag';
        tag.innerHTML = `<svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true" style="fill:currentColor"><path d="M12 2l2.9 6 6.1.5-4.6 4 1.4 6-5.8-3.3L6.2 19l1.4-6-4.6-4 6.1-.5z"/></svg> BEST`;
        best.appendChild(tag);
      }
    }

    function render(){
      const items=load();
      els.count.textContent=String(items.length);
      const has=items.length>0;
      els.table.style.display=has?'table':'none';
      els.empty.style.display=has?'none':'block';
      if(!has){els.body.innerHTML='';return;}
      els.body.innerHTML=items.map(i=>{
        const it=deriveServingFields(i);
        return `
          <tr data-id="${it.id}">
            <td>${it.brand??'‚Äî'}</td>
            <td>${it.product??'‚Äî'}</td>
            <td class="num">${fmt(it.servingSizeG,0)}</td>
            <td class="num">${money(it.pricePerServing)}</td>
            <td class="num" data-protein="${it.proteinPerServing ?? ''}">${fmt(it.proteinPerServing,1)}</td>
            <td class="num">${fmt(it.caloriesPerServing,0)}</td>
            <td class="num">${fmt(it.carbsPerServing,1)}</td>
            <td class="num">${fmt(it.fatPerServing,1)}</td>
            <td><button class="btn remove" data-id="${it.id}">Remove</button></td>
          </tr>
        `;
      }).join('');
      visualizeProteinCells();
    }

    window.Compare={
      add(raw){
        const item=deriveServingFields(raw);
        const items=load();
        const idx=items.findIndex(x=>x.id===item.id);
        if(idx>=0)items[idx]={...items[idx],...item}; else items.push(item);
        save(items); render();
      },
      remove(id){ save(load().filter(x=>x.id!==id)); render(); },
      clear(){ save([]); render(); },
      getAll(){ return load(); },
    };

    document.addEventListener('click',e=>{
      const btn=e.target.closest('.remove');
      if(btn&&btn.dataset.id){e.preventDefault();window.Compare.remove(btn.dataset.id);}
    });

    document.getElementById('clearBtn')?.addEventListener('click',()=>window.Compare.clear());
    document.getElementById('shareBtn')?.addEventListener('click',async()=>{
      const data=window.Compare.getAll();
      const payload=btoa(unescape(encodeURIComponent(JSON.stringify(data))));
      const url=new URL(location.href); url.hash='cmp='+payload;
      try{
        await navigator.clipboard.writeText(url.toString());
        els.share.textContent='Copied!';
        setTimeout(()=>els.share.textContent='Share link',1200);
      }catch{ prompt('Copy this link:',url.toString()); }
    });

    document.getElementById('loadExamplesBtn')?.addEventListener('click',()=>{
      const demo=[
        {id:'esn-designer-vanilla',brand:'ESN',product:'Designer Whey (Vanilla)',servingSizeG:30,proteinPer100g:77,pricePerKg:24.99},
        {id:'optimum-gold-standard',brand:'Optimum Nutrition',product:'Gold Standard Whey',servingSizeG:30,proteinPer100g:76,pricePerKg:28.90},
        {id:'myprotein-impact',brand:'MyProtein',product:'Impact Whey',servingSizeG:25,proteinPer100g:79,pricePerKg:19.99},
      ];
      const cur=load();
      const merged=cur.concat(demo.filter(d=>!cur.some(i=>i.id===d.id)));
      save(merged); render();
    });

    (function importFromHash(){
      const m=location.hash.match(/(^|#|&)cmp=([^&]+)/);
      if(!m)return render();
      try{
        const json=decodeURIComponent(escape(atob(m[2])));
        const items=JSON.parse(json);
        if(Array.isArray(items))save(items);
      }catch{}
      render();
    })();
  })();
  </script>
</body>
</html>